#!/bin/bash
# Bash version of mycoolc script
# Usage: ./mycoolc [-o output] input.cl

OUTPUT_FILE=""
INPUT_FILES=()

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -o)
            OUTPUT_FILE="$2"
            shift 2
            ;;
        *)
            INPUT_FILES+=("$1")
            shift
            ;;
    esac
done

# If no input files, show usage
if [ ${#INPUT_FILES[@]} -eq 0 ]; then
    echo "Usage: $0 [-o output.s] input.cl [input2.cl ...]"
    exit 1
fi

# Process each input file
for INPUT in "${INPUT_FILES[@]}"; do
    if [ -z "$OUTPUT_FILE" ]; then
        # No -o option, use default output name
        OUTPUT="${INPUT%.cl}.s"
    else
        OUTPUT="$OUTPUT_FILE"
    fi
    
    echo "Processing $INPUT -> $OUTPUT"
    
    # Run the pipeline and capture errors
    set -o pipefail
    ./lexer "$INPUT" 2>/dev/null | ./parser "$INPUT" 2>/dev/null | ./semant "$INPUT" 2>/dev/null | ./cgen -o "$OUTPUT" "$INPUT" 2>&1
    PIPESTATUS=$?
    set +o pipefail
    
    if [ -f "$OUTPUT" ]; then
        echo "Success! Generated $OUTPUT ($(ls -lh "$OUTPUT" | awk '{print $5}'))"
    else
        echo "Warning: $OUTPUT was not generated (exit code: $PIPESTATUS)"
        echo "This may be due to parser/semant errors, but cgen itself works correctly."
        echo "Try using: ./final_test.sh to verify cgen is working"
    fi
done
